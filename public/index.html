<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Zorina Nail Studio - Payment</title>
  <script src="https://web.squarecdn.com/v1/square.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #F2EBDD;
      min-height: 100vh;
      padding: 20px;
      color: #333;
      margin: 0;
      width: 100%;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .header {
      background: #5C6B50;
      color: white;
      padding: 30px 20px !important;
      text-align: center;
      border-bottom: 3px solid #F2EBDD;
      height: 380px !important;
      display: flex !important;
      flex-direction: column !important;
      justify-content: center !important;
    }
    
    .logo {
      text-align: center;
      margin-bottom: 10px;
      flex: 1;
        display: flex;
        align-items: center;
      justify-content: center;
    }
    
    .logo-image {
      height: 180px !important;
      width: 90% !important;
      max-width: none !important;
      object-fit: cover !important;
      object-position: center !important;
      filter: brightness(0) invert(1) !important;
    }
    
    
    .subtitle-small {
      font-size: 0.6rem;
      color: #F5F5DC;
      font-weight: 300;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-top: 0;
      flex: 0 0 auto;
    }
    
    .content {
      padding: 40px;
    }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 35px;
      margin-bottom: 30px;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
      font-size: 1.4rem;
      color: #1a1a1a;
      margin-bottom: 25px;
      font-weight: 400;
      display: flex;
      align-items: center;
      gap: 15px;
      letter-spacing: 0.5px;
    }
    
    .section-title::before {
      content: '';
      width: 3px;
      height: 25px;
      background: #5C6B50;
      border-radius: 0;
    }
    
    .search-section-title::before {
      display: block;
    }
    
    .search-section-title {
      padding-left: 0;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
      height: 48px;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #5C6B50;
      box-shadow: 0 0 0 3px rgba(92, 107, 80, 0.1);
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: flex-end;
    }
    
    .form-row > * {
      flex: 1;
    }
    
    .form-row .btn {
      flex: 0 0 auto;
      margin-top: 0;
      width: auto;
      padding: 18px 32px;
      font-size: 1rem;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .search-row {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .search-row .phone-input {
      width: 100%;
    }
    
    .search-row .btn {
      width: auto;
      align-self: flex-start;
      margin-top: 0;
      padding: 12px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .phone-input {
      position: relative;
      display: flex;
      align-items: center;
      border: 2px solid #E5E5E5;
      border-radius: 8px;
      background: white;
      overflow: hidden;
      height: 48px;
      width: 100%;
    }
    
    .phone-prefix {
      background: #F8F9FA;
      color: #6C757D;
      padding: 12px 16px;
      border-right: 1px solid #E5E5E5;
      font-weight: 500;
      font-size: 14px;
      user-select: none;
      white-space: nowrap;
    }
    
    .phone-input-field {
      border: none !important;
      border-radius: 0 !important;
      padding: 12px 16px;
      flex: 1;
      outline: none;
      height: 48px;
    }
    
    .phone-input:focus-within {
      border-color: #5C6B50;
      box-shadow: 0 0 0 3px rgba(92, 107, 80, 0.1);
    }
    
    #card-container {
      height: 48px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      background: white;
      transition: all 0.2s ease;
      position: relative;
      min-height: 48px;
      padding: 0;
      margin: 10px 0 40px 0;
    }
    
    #card-container:focus-within {
      border-color: #ffffff;
      box-shadow: 0 0 0 3px rgba(92, 107, 80, 0.1);
    }
    
    .sq-input {
      height: 100% !important;
      border: none !important;
      border-radius: 8px !important;
      padding: 12px 16px !important;
      font-size: 16px !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
      color: #333 !important;
      background: transparent !important;
      outline: none !important;
      box-shadow: none !important;
    }
    
    .btn {
      background: #5C6B50;
      color: white;
      border: 2px solid #5C6B50;
      padding: 18px 32px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      width: 100%;
      margin-top: 40px;
    }
    
    .btn:hover {
      background: #4A5140;
      color: white;
      border-color: #4A5140;
    }
    
    .btn:disabled {
      background: #e9ecef;
      color: #6c757d;
      border-color: #e9ecef;
      cursor: not-allowed;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 60px 0 20px 0;
      padding: 0;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 24px;
      height: 24px;
      accent-color: #5C6B50;
      cursor: pointer;
      margin: 10;
      position: relative;
      z-index: 1000;
      pointer-events: auto;
    }
    
    .checkbox-group label {
      font-size: 1rem;
      color: #495057;
      cursor: pointer;
      margin-bottom: 0;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .success-button {
      background: #5C6B50;
      color: white;
      border: 2px solid #5C6B50;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0;
      width: auto;
      display: inline-block;
      text-decoration: none;
    }
    
    .success-button:hover {
      background: #4A5140;
      border-color: #4A5140;
      color: white;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0 !important;
        margin: 0 !important;
      }
      
      .container {
        margin: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        width: 100% !important;
        max-width: none !important;
      }
      
      .header {
        padding: 20px 15px !important;
        height: 220px !important;
        width: 100% !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      .logo-image {
        height: 130px !important;
        width: 95% !important;
      }
      
      .content {
        padding: 15px;
        margin: 0 !important;
        width: 100% !important;
      }
      
      .section {
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
      }
      
      .section-title {
        font-size: 1.2rem;
        margin-bottom: 20px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .search-row {
        flex-direction: column;
        gap: 15px;
      }
      
      .form-control {
        padding: 10px 12px;
        font-size: 16px;
      }
      
      .btn {
        padding: 12px 20px;
        font-size: 14px;
        margin-top: 20px;
      }
      
      .search-row .btn {
        padding: 10px 16px;
        font-size: 13px;
        margin-top: 0;
      }
      
      .phone-input {
        font-size: 16px;
      }
      
      .phone-input .country-code {
        padding: 10px 8px;
        font-size: 16px;
      }
      
      .phone-input .phone-number {
        padding: 10px 12px;
        font-size: 16px;
      }
      
      #card-container {
        height: 52px;
        margin: 8px 0 20px 0;
      }
      
      .checkbox-group {
        margin: 60px 0 20px 0;
        padding: 0;
      }
      
      .checkbox-group label {
        font-size: 14px;
        line-height: 1.4;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <img src="./logo_no_bg.webp" alt="Zorina Nail Studio" class="logo-image" />
      </div>
      <div class="subtitle-small">SECURE PAYMENT SETUP</div>
    </div>
    
    <div class="content">
      <!-- Search Customer Section -->
      <div class="section">
        <div class="section-title search-section-title">Search Customer</div>
        <div class="form-row search-row">
          <div class="phone-input">
            <div class="phone-prefix">+1</div>
            <input id="searchPhone" class="form-control phone-input-field" placeholder="(555) 123-4567" type="tel" />
          </div>
          <button id="btnSearchCustomer" class="btn">SEARCH CUSTOMER</button>
        </div>
        <div id="customerSearchResults"></div>
      </div>

      <!-- Create Customer & Payment Section -->
      <div class="section">
        <div class="section-title">Create Customer & Payment</div>
        
        <div class="form-group">
          <label>Full Name</label>
            <div class="form-row">
            <input id="firstName" class="form-control" placeholder="First name" />
            <input id="lastName" class="form-control" placeholder="Last name" />
            </div>
          </div>
        
        <div class="form-group">
          <label>Phone Number</label>
          <div class="phone-input">
            <div class="phone-prefix">+1</div>
            <input id="phone" class="form-control phone-input-field" placeholder="(555) 123-4567" type="tel" />
        </div>
      </div>

        <div class="form-group">
          <label>Payment Information</label>
              <div id="card-container"></div>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="consent" style="position: relative; z-index: 1000; pointer-events: auto;" />
          <label for="consent" style="position: relative; z-index: 1000; pointer-events: auto; user-select: none;">I agree to save my card for future payments and appointments</label>
        </div>
        
        <button id="btnCreate" class="btn">CREATE PROFILE AND SAVE PAYMENT METHOD</button>
        
        <div id="status"></div>
      </div>
    </div>
  </div>

  <script>
    let LOCATION_ID = null; // Will be set from API config
    let payments = null;
    let cardField = null;
    
    function showStatus(msg, isError = false) {
      const status = document.getElementById('status');
      status.className = 'status ' + (isError ? 'status-error' : 'status-success');
      status.textContent = msg;
    }
    
    function goToBooking() {
      // Replace with your actual booking page URL
      const bookingUrl = 'https://studio-zorina.square.site/'; // Update this URL
      window.open(bookingUrl, '_blank');
    }

    async function fetchJson(url, opts = {}) {
      opts.headers = Object.assign({
        'Content-Type': 'application/json'
      }, opts.headers);
      
      console.log('Making request to:', url, 'with options:', opts);
      
      const response = await fetch(url, opts);
      console.log('Response status:', response.status, response.statusText);
      
      if (!response.ok) {
        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        let errorData = null;
        
        try {
          errorData = await response.json();
          console.log('Error response data:', errorData);
          
          if (errorData.error) {
            errorMessage = errorData.error;
          } else if (errorData.message) {
            errorMessage = errorData.message;
          }
          
          if (errorData.details) {
            errorMessage += ` - Details: ${JSON.stringify(errorData.details)}`;
          }
          
          if (errorData.squareErrors && Array.isArray(errorData.squareErrors)) {
            errorMessage += ` - Square Errors: ${JSON.stringify(errorData.squareErrors)}`;
          }
        } catch (e) {
          console.error('Failed to parse error response as JSON:', e);
          console.log('Raw response text:', await response.text().catch(() => 'Could not read response text'));
        }
        
        console.error('Throwing error:', errorMessage);
        throw new Error(errorMessage);
      }
      
      const result = await response.json();
      console.log('Success response:', result);
      return result;
    }
    
    async function tokenizeCard() {
      const result = await cardField.tokenize();
      if (result.status === 'OK') {
        return result.token;
        } else {
        throw new Error(result.errors[0].detail);
      }
    }
    
    // Initialize when page loads
    window.addEventListener('load', async () => {
      try {
        console.log('Initializing Square...');
        
        // Get app config
        const config = await fetchJson('/api/config');
        console.log('Config loaded:', config);
        
        // Check if app ID is available
        if (!config.appId) {
          throw new Error('Square App ID not configured');
        }
        
        // Get location ID from API
        const initCheck = await fetchJson('/api/init');
        console.log('API initialization check:', initCheck);
        
        if (!initCheck.locationId) {
          throw new Error('Square Location ID not configured');
        }
        
        LOCATION_ID = initCheck.locationId;
        console.log('Using Location ID:', LOCATION_ID);
        
        // Initialize Square payments
        payments = window.Square.payments(config.appId, LOCATION_ID);
        console.log('Payments object created with App ID:', config.appId, 'Location ID:', LOCATION_ID);
        
        // Create and attach card field
        cardField = await payments.card();
        await cardField.attach('#card-container');
        console.log('Card field attached successfully');
        
        // Verify API is properly initialized
        if (!initCheck.initialized) {
          console.error('API not properly initialized:', initCheck);
          showStatus('Warning: API not properly initialized. Check server configuration.', true);
        } else {
          console.log('âœ… API properly initialized');
        }
        
      } catch (error) {
        console.error('Initialization error:', error);
        showStatus('Error: ' + error.message, true);
      }
    });
    
    // Button handlers
    document.addEventListener('DOMContentLoaded', () => {
      // Fix checkbox click issue
      const consentCheckbox = document.getElementById('consent');
      const consentLabel = document.querySelector('label[for="consent"]');
      
      if (consentCheckbox && consentLabel) {
        // Multiple event handlers to ensure it works
        const toggleCheckbox = (e) => {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          consentCheckbox.checked = !consentCheckbox.checked;
          consentCheckbox.dispatchEvent(new Event('change'));
          console.log('Checkbox toggled:', consentCheckbox.checked);
        };
        
        consentLabel.addEventListener('click', toggleCheckbox, true);
        consentLabel.addEventListener('mousedown', toggleCheckbox, true);
        consentLabel.addEventListener('touchstart', toggleCheckbox, true);
        
        consentCheckbox.addEventListener('click', (e) => {
          console.log('Checkbox clicked directly:', consentCheckbox.checked);
        }, true);
        
        // Force focus and click on checkbox
        consentCheckbox.addEventListener('focus', () => {
          console.log('Checkbox focused');
        });
      }
      
      // Search customer button
      document.getElementById('btnSearchCustomer').onclick = async () => {
        const phone = document.getElementById('searchPhone').value.trim();
        if (!phone) {
          showStatus('Please enter phone number', true);
          return;
      }
      
      try {
          showStatus('Searching customers...');
          
          // Format phone number to E164 format (add +1 if not present)
          let formattedPhone = phone.replace(/\D/g, ''); // Remove all non-digits
          if (formattedPhone.length === 10) {
            formattedPhone = '+1' + formattedPhone; // Add +1 for US/Canada
          } else if (formattedPhone.length === 11 && formattedPhone.startsWith('1')) {
            formattedPhone = '+' + formattedPhone; // Add + for existing country code
          } else if (!formattedPhone.startsWith('+')) {
            formattedPhone = '+' + formattedPhone; // Add + if missing
          }
          
          // Validate phone number format for Square API
          const phoneRegex = /^\+1[2-9]\d{2}[2-9]\d{6}$/;
          if (!phoneRegex.test(formattedPhone)) {
            showStatus('Please enter a valid US phone number (e.g., +16287893902)', true);
            return;
          }
          
          console.log('Formatted phone:', formattedPhone);
          
          // Search for customers by phone
          const response = await fetchJson('/api/customers/search', {
          method: 'POST',
            headers: {
              'x-merchant-id': 'MLJSE2F6EE60D'
            },
            body: JSON.stringify({ phone: formattedPhone })
          });
          
          const resultsDiv = document.getElementById('customerSearchResults');
          
          if (response.customers && response.customers.length > 0) {
            resultsDiv.innerHTML = `
              <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; margin-top: 15px;">
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                  <div style="width: 8px; height: 8px; background: #5C6B50; border-radius: 50%; margin-right: 12px;"></div>
                  <h3 style="margin: 0; color: #333; font-size: 18px; font-weight: 600;">Found ${response.customers.length} customer${response.customers.length === 1 ? '' : 's'}</h3>
              </div>
                <div style="display: grid; gap: 16px;">
                  ${response.customers.map(customer => `
                    <div style="background: white; border: 1px solid #e9ecef; border-radius: 10px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                          <h4 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 17px; font-weight: 600;">${customer.givenName} ${customer.familyName || ''}</h4>
                          <p style="margin: 0; color: #6c757d; font-size: 14px; font-weight: 500;">${customer.phoneNumber}</p>
            </div>
                        <div style="text-align: right;">
                          <span style="
                            display: inline-block;
                            font-size: 6px;
                            font-weight: 400;
                            text-transform: uppercase;
                            letter-spacing: 0.2px;
                            color: #6c757d;
                          ">
                            ${customer.cards && customer.cards.length > 0 
                              ? `ðŸ’³ ${customer.cards.length} card${customer.cards.length === 1 ? '' : 's'} on file` 
                              : 'No card on file'
                            }
                          </span>
            </div>
          </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
            showStatus('âœ… Customer search completed successfully');
          } else {
            resultsDiv.innerHTML = `
              <div class="status status-error">
                No customers found with phone number: ${phone}
              </div>
            `;
            showStatus('No customers found', true);
          }
          
      } catch (error) {
          console.error('Search error:', error);
          showStatus('Search error: ' + error.message, true);
          document.getElementById('customerSearchResults').innerHTML = '';
        }
      };
      
      // Create customer button
      document.getElementById('btnCreate').onclick = async () => {
        try {
          const firstName = document.getElementById('firstName').value.trim();
          const lastName = document.getElementById('lastName').value.trim();
          const phone = document.getElementById('phone').value.trim();
          const consent = document.getElementById('consent').checked;
          
          if (!firstName || !lastName || !phone) {
            showStatus('Please fill all fields', true);
        return;
      }
        
          if (!consent) {
            showStatus('Please agree to save your card', true);
          return;
          }
          
          // Format phone number to E164 format for customer creation
          let formattedPhone = phone.replace(/\D/g, ''); // Remove all non-digits
          if (formattedPhone.length === 10) {
            formattedPhone = '+1' + formattedPhone; // Add +1 for US/Canada
          } else if (formattedPhone.length === 11 && formattedPhone.startsWith('1')) {
            formattedPhone = '+' + formattedPhone; // Add + for existing country code
          } else if (!formattedPhone.startsWith('+')) {
            formattedPhone = '+' + formattedPhone; // Add + if missing
          }
          
          // Validate phone number format for Square API
          const phoneRegex = /^\+1[2-9]\d{2}[2-9]\d{6}$/;
          if (!phoneRegex.test(formattedPhone)) {
            showStatus('Please enter a valid US phone number (e.g., +16287893902)', true);
            return;
          }
          
          // Check if customer already exists
          showStatus('Checking existing customers...');
          let customer;
          
          try {
            const existingCustomers = await fetchJson('/api/customers/search', {
              method: 'POST',
              headers: {
                'x-merchant-id': 'MLJSE2F6EE60D'
              },
              body: JSON.stringify({ phone: formattedPhone })
            });
            
            if (existingCustomers.customers && existingCustomers.customers.length > 0) {
              // Use existing customer
              customer = existingCustomers.customers[0];
              console.log('Using existing customer:', customer.id);
              showStatus('Found existing customer, adding card...');
              } else {
              // Create new customer
              showStatus('Creating new customer...');
              const newCustomer = await fetchJson('/api/customers', {
          method: 'POST',
          body: JSON.stringify({
                  givenName: firstName,
                  familyName: lastName,
                  phoneNumber: formattedPhone 
                })
              });
              customer = newCustomer.customer;
              console.log('Customer created:', customer.id);
            }
          } catch (error) {
            console.error('Error checking/creating customer:', error);
            showStatus('Error: ' + error.message, true);
            return;
          }
          
          // Tokenize card
          showStatus('Processing payment method...');
          console.log('Starting card tokenization...');
          const token = await tokenizeCard();
          console.log('Card tokenized successfully, token length:', token?.length);

          // Save card
          // Handle both new customer (customer.customer.id) and existing customer (customer.id)
          const customerId = customer.customer ? customer.customer.id : customer.id;
          
          console.log('Creating card with:', {
            sourceId: token?.substring(0, 20) + '...',
            customerId: customerId,
            cardholderName: `${firstName} ${lastName}`.trim()
          });
          
          const cardData = {
            sourceId: token,
            customerId: customerId,
            cardholderName: `${firstName} ${lastName}`.trim()
          };
          
          console.log('Sending card data to API:', {
            ...cardData,
            sourceId: cardData.sourceId?.substring(0, 20) + '...'
          });
          
          const card = await fetchJson('/api/cards', {
            method: 'POST',
            headers: {
              'x-merchant-id': 'MLJSE2F6EE60D'
            },
            body: JSON.stringify(cardData)
          });
        
          console.log('Card saved:', card.card.id);
          
          // Show success message with booking button
          const statusDiv = document.getElementById('status');
          statusDiv.className = 'status status-success';
          statusDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 24px; margin-bottom: 15px;">âœ…</div>
              <h3 style="margin: 0 0 15px 0; color: #155724; font-size: 20px; font-weight: 600;">
                Success! Card Added to Profile
              </h3>
              <p style="margin: 0 0 20px 0; color: #155724; font-size: 16px;">
                Your payment method has been securely saved for future appointments.
              </p>
              <button onclick="goToBooking()" class="success-button">
                Book Appointment Now
              </button>
            </div>
          `;
          
          // Clear form
          document.getElementById('firstName').value = '';
          document.getElementById('lastName').value = '';
          document.getElementById('phone').value = '';
          document.getElementById('consent').checked = false;
          cardField.clear();
            
          } catch (error) {
          console.error('Error:', error);
          
          // Check if it's a token reuse error
          if (error.message.includes('SOURCE_USED') || error.message.includes('Source was used') || error.message.includes('INVALID_REQUEST_ERROR')) {
            showStatus('Card token expired. Please try again with a new card entry.', true);
            // Clear the card field to force re-entry
            if (cardField) {
              cardField.clear();
            }
          } else if (error.message.includes('UNAUTHORIZED') || error.message.includes('401')) {
            showStatus('Authentication error. Please refresh the page and try again.', true);
          } else if (error.message.includes('NOT_FOUND') || error.message.includes('404')) {
            showStatus('Customer not found. Please check the customer information.', true);
          } else {
            showStatus('Error: ' + error.message, true);
          }
        }
      };
    });
  </script>
</body>
</html>
</html>